# PRD: 实验管理中心 (Experiment Management Center)

## 1. 业务愿景与核心逻辑
本模块是 A/B 测试平台的操作中枢，负责管理实验从“创意草案”到“在线运行”再到“结果沉淀”的全生命周期。系统通过**流量层 (Layer)** 解决实验间的互斥冲突，通过**人群筛选**与**白名单**控制实验受众，最终通过**分组配置**链接 Feature 实验值，实现业务逻辑的灰度验证。

### 核心约束原则
1. **流量互斥原则**：同一流量层内的实验互斥执行，共享该层 100% 的流量槽位。不同层之间流量正交，互不干扰。
2. **状态机驱动权限**：实验的编辑权限严格受其状态（草稿、进行中、已结束）约束。随着实验推进，配置项逐步从“自由编辑”转向“只读锁定”。
3. **白名单优先级**：白名单 UID 具备最高优先级，不受人群筛选和流量比例限制，强制进入指定分组。
4. **UID 唯一性约束**：同一实验内，一个 UID 禁止同时出现在多个分组的白名单中，以防分流逻辑冲突。
5. **实验组必要性**：每个实验必须至少包含一个实验组 (Experimental Group)，且必须绑定对应的实验值，否则无法开启实验。

---

## 2. 数据字典 (Data Definitions)

### 2.1 实验基本信息 (Basic Info)
| 字段名称         | 字段 Key（以研发设计方方案为准） | 数据类型 | 描述与限制                                                    |
| :--------------- | :------------------------------- | :------- | :------------------------------------------------------------ |
| **实验名称**     | `name`                           | String   | 必填。描述实验目的，如“首页推荐算法 V2 测试”。                |
| **关联 Feature** | `featureId`                      | ID       | 必填。遵循“一 Feature 一实验”原则，关联后决定可调用的实验值。 |
| **负责人**       | `owner`                          | String   | 必填。实验的直接责任人。                                      |
| **开始时间**     | `startTime`                      | DateTime | 可选。计划或实际开始时间。                                    |
| **实验描述**     | `description`                    | String   | 实验背景及目标的详细补充。                                    |

### 2.2 生效策略与分流 (Strategy)
| 字段名称       | 字段 Key       | 数据类型   | 描述与限制                                                     |
| :------------- | :------------- | :--------- | :------------------------------------------------------------- |
| **流量层**     | `layerId`      | ID         | 实验所属的流量互斥层，如“首页 UI 层”。                         |
| **预占用规模** | `totalTraffic` | Percentage | 该实验在所属层中占据的流量比例 (1-100%)。                      |
| **人群筛选**   | `audience`     | Array      | 目标受众标签，如“新用户”、“iOS”。**多选时遵循 OR (或) 逻辑。** |

### 2.3 实验分组与配置 (Grouping)
| 字段名称         | 字段 Key      | 数据类型   | 描述与限制                                          |
| :--------------- | :------------ | :--------- | :-------------------------------------------------- |
| **分组名称**     | `name`        | String     | 组名，如“对照组”、“实验组 A”。                      |
| **分组类型**     | `isControl`   | Boolean    | 必须包含且仅一个对照组；必须包含至少一个实验组。    |
| **流量占比**     | `ratio`       | Percentage | 该组分配到的实验总流量百分比（层内总和需为 100%）。 |
| **白名单 (UID)** | `whitelist`   | String     | 逗号或换行分隔的 UID 列表。                         |
| **分组介绍**     | `description` | String     | 描述该组的具体策略差异。                            |
| **绑定实验值**   | `variationId` | ID         | 关联 Feature 下的具体配置方案（实验值）。           |

---

## 3. 实验生命周期状态机

| 状态                 | 入口操作按钮 | 编辑权限描述                                                                                 | 终点按钮文字 |
| :------------------- | :----------- | :------------------------------------------------------------------------------------------- | :----------- |
| **草稿 (Draft)**     | 编辑         | **全开放**：所有步骤及字段均可修改。                                                         | 保存修改     |
| **进行中 (Ongoing)** | 编辑         | **受限编辑**：仅允许修改“预占用流量比例”和“分组内部配比”，禁止修改流量层、人群及实验值绑定。 | 保存修改     |
| **已结束 (Ended)**   | 查看详情     | **完全只读**：所有字段锁定，仅供归档查阅。                                                   | 完成         |

---

## 4. 实验状态与编辑权限精细化矩阵 (Permissions Matrix)
为了兼顾“实验数据的严谨性”与“线上调优的灵活性”，系统对不同状态下的各步骤字段设定了精细的锁定策略。

| 步骤                 | 配置项                 |    草稿 (Draft)    |   进行中 (Ongoing)    | 已结束 (Ended) |
| :------------------- | :--------------------- | :----------------: | :-------------------: | :------------: |
| **Step 1: 基本信息** | 实验名称、负责人、描述 |        编辑        |       **锁定**        |    **锁定**    |
|                      | 关联 Feature           |        编辑        |       **锁定**        |    **锁定**    |
|                      | 开始时间               |        编辑        |       **锁定**        |    **锁定**    |
| **Step 2: 生效策略** | 流量层 (Layer)         |        编辑        |       **锁定**        |    **锁定**    |
|                      | 人群筛选 (Audience)    | **编辑 (OR 逻辑)** |       **锁定**        |    **锁定**    |
|                      | **本实验预占用比例**   |        编辑        |  **编辑 (允许调流)**  |    **锁定**    |
| **Step 3: 实验分组** | 分组增删、分组名称     |        编辑        |       **锁定**        |    **锁定**    |
|                      | 分组介绍、白名单 UID   |        编辑        |       **锁定**        |    **锁定**    |
|                      | 绑定实验值             |        编辑        |       **锁定**        |    **锁定**    |
|                      | **组内流量比例 (%)**   |        编辑        | **可编辑 (允许调优)** |    **锁定**    |

---

## 5. 用户故事集 (User Stories)

### 5.1 实验创建与配置 (Step 1 - Step 3)

#### 【故事 01】分步骤引导表单 (Step 1)
通过弹窗或分步页面（基本信息 -> 策略 -> 分组）引导，降低配置复杂度。
* **验收标准**：
  * 面板需实时校验流量总额（100%）。
  * 必须关联 Feature 才能进入后序步骤。

#### 【故事 02】流量层选择与互斥逻辑 (Step 2)
在配置生效策略时，从预设的垂直流量层中进行选择（如首页层、搜索层），以实现同一层内实验的物理互斥。
* **验收标准**：
  * 不同层之间流量正交（总和可超 100%），同层内流量互斥（总和上限 100%）。

#### 【故事 03】层内流量可视化概览 (Step 2)
选择流量层后，展示该层当前的流量占用状况条，清晰标记各在线实验的份额及空闲比例。
* **验收标准**：
  * 状态条需以不同颜色区分在线实验，并悬浮展示实验名称。

#### 【故事 04】流量预占用与防止超发 (Step 2)
输入本实验预占用比例时，系统实时计算并在状态条上预览其占据的份额，若超过该层剩余可用流量则禁止保存。
* **验收标准**：
  * 输入值超出可用流量时，输入框显示红色错误提示。

#### 【故事 05】目标人群精准筛选 (Step 2)
通过下拉搜索并添加多个标签对实验受众进行限定，仅符合条件的请求才会进入分桶。**多个人群包之间是 OR (或) 的关系，即用户只要满足其中一个人群规则即可被计入。**
* **验收标准**：
  * 支持模糊搜索预设的人群标签包。
  * 在 UI 界面通过引导文字明确多个人群包之间的 OR 逻辑。

#### 【故事 06】分组类型定义与实验值绑定 (Step 3)
为实验划分不同的受纳组。每个实验必须包含一个对照组（链接默认 Feature 表现）和至少一个实验组（链接待验证的实验值）。
* **验收标准**：
  * 每个组必须绑定 Feature 下的一个具体实验值配置，并支持实时预览其参数详情。

#### 【故事 07】组内流量哈希加权分配 (Step 3)
手动分配实验总流量在各组间的比例。
* **验收标准**：
  * 页面实时计算已分配比例之和，若不等于 100% 则显示红色告警。

#### 【故事 08】白名单强制命中逻辑 (Step 3)
在各分组中录入特定的用户 UID，使其无视哈希计算和人群筛选，强制进入指定分组路径。
* **验收标准**：
  * 点击保存时检查跨组间的 UID 重复性冲突。

### 5.2 运行中优化与管控

#### 【故事 09】动态调流 (Hot Update)
实验开启后仍能微调占用规模，以便于进行小比例灰度后的全量扩容。
* **业务逻辑**：进行中实验仅开放流量修改权限。

#### 【故事 10】UID 冲突预校验
在点击“保存”时，系统能自动检查同一实验中不同分组间是否存在重复的 UID，保证分流结果的确定性。
* **业务逻辑**：发现重复 UID 时弹出 Error 消息并阻止保存。

#### 【故事 11】不进入新用户模式
当进行中实验的流量占比微调至 0% 时，实验应进入特殊观察期状态。
* **业务逻辑**：此时老用户保持原路径分流，新用户不再进入实验。列表页需有明确的“不进入新用户”状态标注。

