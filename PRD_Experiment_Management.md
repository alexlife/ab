# PRD: 实验管理中心 (Experiment Management Center)

## 1. 业务愿景与核心逻辑
本模块是 A/B 测试平台的操作中枢，负责管理实验从“创意草案”到“在线运行”再到“结果沉淀”的全生命周期。系统通过**流量层 (Layer)** 解决实验间的互斥冲突，通过**人群筛选**与**白名单**控制实验受众，最终通过**分组配置**链接 Feature 变体，实现业务逻辑的灰度验证。

### 核心约束原则
1. **流量互斥原则**：同一流量层内的实验互斥执行，共享该层 100% 的流量槽位。不同层之间流量正交，互不干扰。
2. **状态机驱动权限**：实验的编辑权限严格受其状态（草稿、进行中、已结束）约束。随着实验推进，配置项逐步从“自由编辑”转向“只读锁定”。
3. **白名单优先级**：白名单 UID 具备最高优先级，不受人群筛选和流量比例限制，强制进入指定分组。
4. **UID 唯一性约束**：同一实验内，一个 UID 禁止同时出现在多个分组的白名单中，以防分流逻辑冲突。

---

## 2. 数据字典 (Data Definitions)

### 2.1 实验基本信息 (Basic Info)
| 字段名称         | 字段 Key      | 数据类型 | 描述与限制                                                  |
| :--------------- | :------------ | :------- | :---------------------------------------------------------- |
| **实验名称**     | `name`        | String   | 必填。描述实验目的，如“首页推荐算法 V2 测试”。              |
| **关联 Feature** | `featureId`   | ID       | 必填。遵循“一 Feature 一实验”原则，关联后决定可调用的变体。 |
| **负责人**       | `owner`       | String   | 必填。实验的直接责任人。                                    |
| **开始时间**     | `startTime`   | DateTime | 可选。计划或实际开始时间。                                  |
| **实验描述**     | `description` | String   | 实验背景及目标的详细补充。                                  |

### 2.2 生效策略与分流 (Strategy)
| 字段名称       | 字段 Key       | 数据类型   | 描述与限制                                |
| :------------- | :------------- | :--------- | :---------------------------------------- |
| **流量层**     | `layerId`      | ID         | 实验所属的流量互斥层，如“首页 UI 层”。    |
| **预占用规模** | `totalTraffic` | Percentage | 该实验在所属层中占据的流量比例 (1-100%)。 |
| **人群筛选**   | `audience`     | Array      | 目标受众标签，如“新用户”、“iOS”。         |

### 2.3 实验分组与配置 (Grouping)
| 字段名称         | 字段 Key      | 数据类型   | 描述与限制                                          |
| :--------------- | :------------ | :--------- | :-------------------------------------------------- |
| **分组名称**     | `name`        | String     | 组名，如“对照组”、“实验组 A”。                      |
| **对照组标识**   | `isControl`   | Boolean    | 每个实验必须且仅有一个对照组。                      |
| **流量占比**     | `ratio`       | Percentage | 该组分配到的实验总流量百分比（全组总和需为 100%）。 |
| **白名单 (UID)** | `whitelist`   | String     | 逗号或换行分隔的 UID 列表。                         |
| **分组介绍**     | `description` | String     | 描述该组的具体策略差异。                            |
| **绑定变体**     | `variationId` | ID         | 关联 Feature 下的具体配置方案。                     |

---

## 3. 实验生命周期状态机

| 状态                 | 入口操作按钮 | 编辑权限描述                                                                               | 终点按钮文字 |
| :------------------- | :----------- | :----------------------------------------------------------------------------------------- | :----------- |
| **草稿 (Draft)**     | 编辑         | **全开放**：所有步骤及字段均可修改。                                                       | 保存修改     |
| **进行中 (Ongoing)** | 编辑         | **受限编辑**：仅允许修改“预占用流量比例”和“分组内部配比”，禁止修改流量层、人群及变体绑定。 | 保存修改     |
| **已结束 (Ended)**   | 查看详情     | **完全只读**：所有字段锁定，仅供归档查阅。                                                 | 完成         |

---

## 4. 实验状态与编辑权限精细化矩阵 (Permissions Matrix)
为了兼顾“实验数据的严谨性”与“线上调优的灵活性”，系统对不同状态下的各步骤字段设定了精细的锁定策略。

| 步骤                 | 配置项                 | 草稿 (Draft) |  进行中 (Ongoing)   | 已结束 (Ended) |
| :------------------- | :--------------------- | :----------: | :-----------------: | :------------: |
| **Step 1: 基本信息** | 实验名称、负责人、描述 |     编辑     |      **锁定**       |    **锁定**    |
|                      | 关联 Feature           |     编辑     |      **锁定**       |    **锁定**    |
|                      | 开始时间               |     编辑     |      **锁定**       |    **锁定**    |
| **Step 2: 生效策略** | 流量层 (Layer)         |     编辑     |      **锁定**       |    **锁定**    |
|                      | 人群筛选 (Audience)    |     编辑     |      **锁定**       |    **锁定**    |
|                      | **本实验预占用比例**   |     编辑     | **编辑 (允许调流)** |    **锁定**    |
| **Step 3: 实验分组** | 分组增删、分组名称     |     编辑     |      **锁定**       |    **锁定**    |
|                      | 分组介绍、白名单 UID   |     编辑     |      **锁定**       |    **锁定**    |
|                      | 绑定变体 (Variation)   |     编辑     |      **锁定**       |    **锁定**    |
|                      | **组内流量比例 (%)**   |     编辑     | **编辑 (允许调优)** |    **锁定**    |

---

## 5. 用户故事集 (User Stories)

### 5.1 实验创建与配置
#### 【故事史诗 01】分步骤引导表单
**作为** 实验人员，**我希望** 通过弹窗或分步页面（基本信息 -> 策略 -> 分组）引导，**以便于** 降低配置复杂度。
* **验收标准**：
  * 面板需实时校验流量总额（100%）。
  * 必须关联 Feature 才能进入第三步分组。

#### 【故事史诗 02】可视化流量分配
**作为** 实验设计者，**我希望** 在选择流量层时能看到该层已有的实验占用情况（进度条形式），**以便于** 避免流量挤兑。
* **验收标准**：
  * 如果预占用规模超过剩余可用流量，输入框需报错提示。

### 4.2 运行中优化与管控
#### 【故事史诗 03】动态动态调流 (Hot Update)
**作为** 实验人员，**我希望** 实验开启后仍能微调占用规模，**以便于** 进行小比例灰度后的全量扩容。
* **业务逻辑**：进行中实验仅开放流量 InputNumber 权限。

#### 【故事史诗 04】UID 冲突预校验
**作为** 开发人员，**我希望** 在点击“保存”时，系统能自动检查不同分组间是否存在重复的 UID，**以便于** 保证分流结果的确定性。
* **业务逻辑**：发现重复 UID 时弹出 Error 消息并阻止保存。

---

## 5. UI 规范与视觉对齐
* **层级色盲区分**：
  * **首页 UI 层**: 蓝色 (#1677ff)
  * **推荐算法层**: 绿色 (#52c41a)
  * **策略层**: 橙色 (#fa8c16)
  * *注：底色采用浅色填充，文字深色，移除边框使视觉更轻量。*
* **点击行为**:
  * 列表页“实验名称”可直接点击跳转，依据状态自动进入“编辑”或“详情”模式。
* **空状态处理**:
  * 若 Feature 变体未绑定，分组卡片内需展示 Empty 状态提示。
